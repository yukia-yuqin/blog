---


---

<hr>
<h2 id="layout-posttitle-dubbo不输出日志文件tags-java-spring-dubbocategories-java">layout: post<br>
title: dubbo不输出日志文件<br>
tags: java spring dubbo<br>
categories: java</h2>
<h2 id="背景：dubbo的provider端控制台不输出日志">背景：dubbo的provider端控制台不输出日志</h2>
<ul>
<li>三个现象：binding过多，log4j没有appender，dubbo打印不出日志</li>
</ul>
<h2 id="原因">原因</h2>
<ul>
<li>binding过多，有logback-classic,logback-core,log4j,log4j-to-slf4j,jboss-logging,slf4j-log4j12,spring-boot-starter-logging,jul-to-slf4j,slf4j-api</li>
<li>dubbo默认使用log4j。</li>
<li>解决步骤
<ul>
<li>去掉log4j日志：不提示log4j的warn，dubbo打印日志</li>
<li>进一步去掉slf4j-log4j12：不提示Binding过多。</li>
</ul>
</li>
</ul>
<h2 id="原理">原理</h2>
<p>dubbo的loggerFactory源码，查找日志适配器部分</p>
<pre><code>// 查找常用的日志框架
	static {
	    String logger = System.getProperty("dubbo.application.logger");
	    if ("slf4j".equals(logger)) {
    		setLoggerAdapter(new Slf4jLoggerAdapter());
    	} else if ("jcl".equals(logger)) {
    		setLoggerAdapter(new JclLoggerAdapter());
    	} else if ("log4j".equals(logger)) {
    		setLoggerAdapter(new Log4jLoggerAdapter());
    	} else if ("jdk".equals(logger)) {
    		setLoggerAdapter(new JdkLoggerAdapter());
    	} else {
    		try {
    			setLoggerAdapter(new Log4jLoggerAdapter());
            } catch (Throwable e1) {
                try {
                	setLoggerAdapter(new Slf4jLoggerAdapter());
                } catch (Throwable e2) {
                    try {
                    	setLoggerAdapter(new JclLoggerAdapter());
                    } catch (Throwable e3) {
                        setLoggerAdapter(new JdkLoggerAdapter());
                    }
                }
            }
    	}
	}
</code></pre>
<h2 id="slf4j源码解读">slf4j源码解读</h2>
<blockquote>
<ul>
<li>Binding是一个什么动作？  找到SLF4JServiceProvider的实现</li>
<li>SLF4J是如何整合不同的日志框架的?  增加一个第三方的通用接口。</li>
<li>Class Path中为什么只能有且仅有一种日志框架的binding?</li>
</ul>
</blockquote>
<h5 id="几个重要模块：">几个重要模块：</h5>
<p><code>slf4j-api</code> 是 SLF4J 的核心模块，所有的日志抽象接口都放在这里面；<code>slf4j-simple</code> 是一种 SLF4J 日志规范的实现，类似于 logback、log4j； <code>slf4j-log4j12</code> 和 <code>slf4j-jdk14</code> 是通过适配器的方式使得 log4j 和 JDK logger 满足 SLF4J 日志规范，而 logback 是天生支持 SLF4J 规范，所以不再需要适配器。</p>
<ul>
<li>slf4j-api   LoggerFactory.java</li>
</ul>
<pre class=" language-java"><code class="prism  language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> Logger <span class="token function">getLogger</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     ILoggerFactory iLoggerFactory <span class="token operator">=</span> <span class="token function">getILoggerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> iLoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">static</span> SLF4JServiceProvider <span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INITIALIZATION_STATE <span class="token operator">==</span> UNINITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>LoggerFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>INITIALIZATION_STATE <span class="token operator">==</span> UNINITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    INITIALIZATION_STATE <span class="token operator">=</span> ONGOING_INITIALIZATION<span class="token punctuation">;</span>
                    <span class="token function">performInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>INITIALIZATION_STATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SUCCESSFUL_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">return</span> PROVIDER<span class="token punctuation">;</span>
        <span class="token keyword">case</span> NOP_FALLBACK_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">return</span> NOP_FALLBACK_FACTORY<span class="token punctuation">;</span>
        <span class="token keyword">case</span> FAILED_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>UNSUCCESSFUL_INIT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ONGOING_INITIALIZATION<span class="token operator">:</span>
            <span class="token comment">// support re-entrant behavior.</span>
            <span class="token comment">// See also http://jira.qos.ch/browse/SLF4J-97</span>
            <span class="token keyword">return</span> SUBST_PROVIDER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unreachable code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providersList <span class="token operator">=</span> <span class="token function">findServiceProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reportMultipleBindingAmbiguity</span><span class="token punctuation">(</span>providersList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>providersList <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>providersList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           PROVIDER <span class="token operator">=</span> providersList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// SLF4JServiceProvider.initialize() is intended to be called here and nowhere else.</span>
           PROVIDER<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           INITIALIZATION_STATE <span class="token operator">=</span> SUCCESSFUL_INITIALIZATION<span class="token punctuation">;</span>
            <span class="token function">reportActualBinding</span><span class="token punctuation">(</span>providersList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            INITIALIZATION_STATE <span class="token operator">=</span> NOP_FALLBACK_INITIALIZATION<span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"No SLF4J providers were found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Defaulting to no-operation (NOP) logger implementation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"See "</span> <span class="token operator">+</span> NO_PROVIDERS_URL <span class="token operator">+</span> <span class="token string">" for further details."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Set<span class="token operator">&lt;</span>URL<span class="token operator">&gt;</span> staticLoggerBinderPathSet <span class="token operator">=</span> <span class="token function">findPossibleStaticLoggerBinderPathSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reportIgnoredStaticLoggerBinders</span><span class="token punctuation">(</span>staticLoggerBinderPathSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">postBindCleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">failedBinding</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected initialization failure"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> <span class="token function">findServiceProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceLoader<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> serviceLoader <span class="token operator">=</span> ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>SLF4JServiceProvider<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 一个基于java.util.serviceLoader范式实现的接口</span>
        List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providerList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SLF4JServiceProvider provider <span class="token operator">:</span> serviceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            providerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> providerList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">reportMultipleBindingAmbiguity</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAmbiguousProviderList</span><span class="token punctuation">(</span>providerList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Class path contains multiple SLF4J providers."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SLF4JServiceProvider provider <span class="token operator">:</span> providerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Found provider ["</span> <span class="token operator">+</span> provider <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"See "</span> <span class="token operator">+</span> MULTIPLE_BINDINGS_URL <span class="token operator">+</span> <span class="token string">" for an explanation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="slf4j适配层">SLF4J适配层</h5>
<p>​	<img src="http://image.55555.io/blog_slf4j_adapter.png" alt="slf4j adapter"></p>
<p>slf4j默认实现是logback，如果要使用 log4j 和 java.util.logging 作为 slf4j 的实现，就需要一个适配层，在 slf4j 的项目中，<code>slf4j-log4j12</code> 和 <code>slf4j-jdk14</code> 就是该适配层。其实该适配层的核心思想就是设计模式中的适配器模式。本节以 <code>slf4j-log4j12</code> 模块来说明。</p>
<pre><code> final transient org.apache.log4j.Logger logger;  实际代理了org.apache.log4j.Logger类,所以对Log4jLoggerAdapter的所有方法调用,最终调用的都是org.apache.log4j.Logger对应的方法
</code></pre>
<h2 id="解决方法">解决方法</h2>
<h3 id="方法一：强制dubbo使用slf4j，以下任意一种配置均可">方法一：强制dubbo使用slf4j，以下任意一种配置均可</h3>
<pre><code>方法1.1  &lt;dubbo:application name="knowledge-analysis" logger="slf4j"/&gt;
方法1.2 -Ddubbo.application.logger=slf4j
方法1.3  System.setProperty("dubbo.application.logger","slf4j");
观察到：
c.a.d.common.logger.LoggerFactory - using logger: com.alibaba.dubbo.common.logger.log4j.Log4jLoggerAdapter  ×
变为：
c.a.d.common.logger.LoggerFactory - using logger: com.alibaba.dubbo.common.logger.slf4j.Slf4jLoggerAdapter  √
</code></pre>
<h2 id="拓展">拓展</h2>
<h3 id="关于log4j2">关于Log4j2</h3>
<p>在日志框架中，以Log4j + Slf4j的使用组合最为常见，但是我们知道Log4j目前已经停止更新了。Apache推出了新的Log4j2来代替Log4j，Log4j2是对Log4j的升级，与其前身Log4j相比有了显着的改进，并提供了许多Logback可用的改进，同时解决了Logback体系结构中的一些固有问题。因此，Log4j2 + Slf4j应该是未来的大势所趋。</p>
<h3 id="代理和适配的区别">代理和适配的区别</h3>
<p>适配器模式是<strong>因为新旧接口不一致导致出现了客户端无法得到满足的问题</strong>，但是，由于旧的接口是不能被完全重构掉的，因为我们还想使用实现了这个接口的一些服务。那么<strong>为了使用以前实现旧接口的服务，我们就应该把新的接口转换成旧接口</strong>，实现这个转换的类就是抽象意义的转换器。相比于适配器的应用场景，代理就不一样了，虽然代理也同样是增加了一层，但是，<strong>代理提供的接口和原本的接口是一样的</strong>，代理模式的作用<strong>是不把实现直接暴露给client，而是通过代理这个层，代理能够做一些处理</strong>。</p>
<hr>
<h2 id="layout-posttitle-dubbo不输出日志文件tags-java-spring-dubbocategories-java-1">layout: post<br>
title: dubbo不输出日志文件<br>
tags: java spring dubbo<br>
categories: java</h2>
<h2 id="背景：dubbo的provider端控制台不输出日志-1">背景：dubbo的provider端控制台不输出日志</h2>
<ul>
<li>三个现象：binding过多，log4j没有appender，dubbo打印不出日志</li>
</ul>
<h2 id="原因-1">原因</h2>
<ul>
<li>binding过多，有logback-classic,logback-core,log4j,log4j-to-slf4j,jboss-logging,slf4j-log4j12,spring-boot-starter-logging,jul-to-slf4j,slf4j-api</li>
<li>dubbo默认使用log4j。</li>
<li>解决步骤
<ul>
<li>去掉log4j日志：不提示log4j的warn，dubbo打印日志</li>
<li>进一步去掉slf4j-log4j12：不提示Binding过多。</li>
</ul>
</li>
</ul>
<h2 id="原理-1">原理</h2>
<p>dubbo的loggerFactory源码，查找日志适配器部分</p>
<pre><code>// 查找常用的日志框架
	static {
	    String logger = System.getProperty("dubbo.application.logger");
	    if ("slf4j".equals(logger)) {
    		setLoggerAdapter(new Slf4jLoggerAdapter());
    	} else if ("jcl".equals(logger)) {
    		setLoggerAdapter(new JclLoggerAdapter());
    	} else if ("log4j".equals(logger)) {
    		setLoggerAdapter(new Log4jLoggerAdapter());
    	} else if ("jdk".equals(logger)) {
    		setLoggerAdapter(new JdkLoggerAdapter());
    	} else {
    		try {
    			setLoggerAdapter(new Log4jLoggerAdapter());
            } catch (Throwable e1) {
                try {
                	setLoggerAdapter(new Slf4jLoggerAdapter());
                } catch (Throwable e2) {
                    try {
                    	setLoggerAdapter(new JclLoggerAdapter());
                    } catch (Throwable e3) {
                        setLoggerAdapter(new JdkLoggerAdapter());
                    }
                }
            }
    	}
	}
</code></pre>
<h2 id="slf4j源码解读-1">slf4j源码解读</h2>
<blockquote>
<ul>
<li>Binding是一个什么动作？  找到SLF4JServiceProvider的实现</li>
<li>SLF4J是如何整合不同的日志框架的?  增加一个第三方的通用接口。</li>
<li>Class Path中为什么只能有且仅有一种日志框架的binding?</li>
</ul>
</blockquote>
<h5 id="几个重要模块：-1">几个重要模块：</h5>
<p><code>slf4j-api</code> 是 SLF4J 的核心模块，所有的日志抽象接口都放在这里面；<code>slf4j-simple</code> 是一种 SLF4J 日志规范的实现，类似于 logback、log4j； <code>slf4j-log4j12</code> 和 <code>slf4j-jdk14</code> 是通过适配器的方式使得 log4j 和 JDK logger 满足 SLF4J 日志规范，而 logback 是天生支持 SLF4J 规范，所以不再需要适配器。</p>
<ul>
<li>slf4j-api   LoggerFactory.java</li>
</ul>
<pre class=" language-java"><code class="prism  language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> Logger <span class="token function">getLogger</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     ILoggerFactory iLoggerFactory <span class="token operator">=</span> <span class="token function">getILoggerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> iLoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">static</span> SLF4JServiceProvider <span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INITIALIZATION_STATE <span class="token operator">==</span> UNINITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>LoggerFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>INITIALIZATION_STATE <span class="token operator">==</span> UNINITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    INITIALIZATION_STATE <span class="token operator">=</span> ONGOING_INITIALIZATION<span class="token punctuation">;</span>
                    <span class="token function">performInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>INITIALIZATION_STATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SUCCESSFUL_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">return</span> PROVIDER<span class="token punctuation">;</span>
        <span class="token keyword">case</span> NOP_FALLBACK_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">return</span> NOP_FALLBACK_FACTORY<span class="token punctuation">;</span>
        <span class="token keyword">case</span> FAILED_INITIALIZATION<span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>UNSUCCESSFUL_INIT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ONGOING_INITIALIZATION<span class="token operator">:</span>
            <span class="token comment">// support re-entrant behavior.</span>
            <span class="token comment">// See also http://jira.qos.ch/browse/SLF4J-97</span>
            <span class="token keyword">return</span> SUBST_PROVIDER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unreachable code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providersList <span class="token operator">=</span> <span class="token function">findServiceProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reportMultipleBindingAmbiguity</span><span class="token punctuation">(</span>providersList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>providersList <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>providersList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           PROVIDER <span class="token operator">=</span> providersList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// SLF4JServiceProvider.initialize() is intended to be called here and nowhere else.</span>
           PROVIDER<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           INITIALIZATION_STATE <span class="token operator">=</span> SUCCESSFUL_INITIALIZATION<span class="token punctuation">;</span>
            <span class="token function">reportActualBinding</span><span class="token punctuation">(</span>providersList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            INITIALIZATION_STATE <span class="token operator">=</span> NOP_FALLBACK_INITIALIZATION<span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"No SLF4J providers were found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Defaulting to no-operation (NOP) logger implementation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"See "</span> <span class="token operator">+</span> NO_PROVIDERS_URL <span class="token operator">+</span> <span class="token string">" for further details."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Set<span class="token operator">&lt;</span>URL<span class="token operator">&gt;</span> staticLoggerBinderPathSet <span class="token operator">=</span> <span class="token function">findPossibleStaticLoggerBinderPathSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reportIgnoredStaticLoggerBinders</span><span class="token punctuation">(</span>staticLoggerBinderPathSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">postBindCleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">failedBinding</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected initialization failure"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> <span class="token function">findServiceProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceLoader<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> serviceLoader <span class="token operator">=</span> ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>SLF4JServiceProvider<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 一个基于java.util.serviceLoader范式实现的接口</span>
        List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providerList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SLF4JServiceProvider provider <span class="token operator">:</span> serviceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            providerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> providerList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">reportMultipleBindingAmbiguity</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>SLF4JServiceProvider<span class="token operator">&gt;</span> providerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAmbiguousProviderList</span><span class="token punctuation">(</span>providerList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Class path contains multiple SLF4J providers."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SLF4JServiceProvider provider <span class="token operator">:</span> providerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"Found provider ["</span> <span class="token operator">+</span> provider <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Util<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token string">"See "</span> <span class="token operator">+</span> MULTIPLE_BINDINGS_URL <span class="token operator">+</span> <span class="token string">" for an explanation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="slf4j适配层-1">SLF4J适配层</h5>
<p>​	<img src="http://image.55555.io/blog_slf4j_adapter.png" alt="slf4j adapter"></p>
<p>slf4j默认实现是logback，如果要使用 log4j 和 java.util.logging 作为 slf4j 的实现，就需要一个适配层，在 slf4j 的项目中，<code>slf4j-log4j12</code> 和 <code>slf4j-jdk14</code> 就是该适配层。其实该适配层的核心思想就是设计模式中的适配器模式。本节以 <code>slf4j-log4j12</code> 模块来说明。</p>
<pre><code> final transient org.apache.log4j.Logger logger;  实际代理了org.apache.log4j.Logger类,所以对Log4jLoggerAdapter的所有方法调用,最终调用的都是org.apache.log4j.Logger对应的方法
</code></pre>
<h2 id="解决方法-1">解决方法</h2>
<h3 id="方法一：强制dubbo使用slf4j，以下任意一种配置均可-1">方法一：强制dubbo使用slf4j，以下任意一种配置均可</h3>
<pre><code>方法1.1  &lt;dubbo:application name="knowledge-analysis" logger="slf4j"/&gt;
方法1.2 -Ddubbo.application.logger=slf4j
方法1.3  System.setProperty("dubbo.application.logger","slf4j");
观察到：
c.a.d.common.logger.LoggerFactory - using logger: com.alibaba.dubbo.common.logger.log4j.Log4jLoggerAdapter  ×
变为：
c.a.d.common.logger.LoggerFactory - using logger: com.alibaba.dubbo.common.logger.slf4j.Slf4jLoggerAdapter  √
</code></pre>
<h2 id="拓展-1">拓展</h2>
<h3 id="关于log4j2-1">关于Log4j2</h3>
<p>在日志框架中，以Log4j + Slf4j的使用组合最为常见，但是我们知道Log4j目前已经停止更新了。Apache推出了新的Log4j2来代替Log4j，Log4j2是对Log4j的升级，与其前身Log4j相比有了显着的改进，并提供了许多Logback可用的改进，同时解决了Logback体系结构中的一些固有问题。因此，Log4j2 + Slf4j应该是未来的大势所趋。</p>
<h3 id="代理和适配的区别-1">代理和适配的区别</h3>
<p>适配器模式是<strong>因为新旧接口不一致导致出现了客户端无法得到满足的问题</strong>，但是，由于旧的接口是不能被完全重构掉的，因为我们还想使用实现了这个接口的一些服务。那么<strong>为了使用以前实现旧接口的服务，我们就应该把新的接口转换成旧接口</strong>，实现这个转换的类就是抽象意义的转换器。相比于适配器的应用场景，代理就不一样了，虽然代理也同样是增加了一层，但是，<strong>代理提供的接口和原本的接口是一样的</strong>，代理模式的作用<strong>是不把实现直接暴露给client，而是通过代理这个层，代理能够做一些处理</strong>。</p>

